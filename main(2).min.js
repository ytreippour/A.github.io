(function(){function a(a){var t=$(".vote-options");a.length&&t.length&&("pk"==a.val()?(t.children().eq(1).nextAll().remove(),t.data("max",2).cloneable()):t.data("max",10).cloneable())}var t=$("body");t.on("click","[ajax-action]",function(){var a=$(this);if(a.attr("disabled"))return!1;var t=a.attr("data-id"),e=a.attr("ajax-action"),i=a.find("text");i=i.length?i:a.siblings("text");var n=i.html();a.attr("disabled",!0),i.html('<i class="loading-spot"><i></i></i>'),$.ajax({type:"POST",url:_win.ajax_url,dataType:"json",data:{id:t,action:e},error:function(t){var e="操作失败 "+t.status+" "+t.statusText+"，请刷新页面后重试";t.responseText&&t.responseText.indexOf("致命错误")>-1&&(e="网站遇到致命错误，请检查插件冲突或通过错误日志排除错误"),notyf(e,"danger"),a.attr("disabled",!1),i.html(n)},success:function(s){a.attr("disabled",!1),s.data&&s.success?(s=s.data,$('[ajax-action="'+e+'"][data-id="'+t+'"]').each(function(){var a=$(this),t=a.find("text");t=t.length?t:a.siblings("text"),t.html(s.text||n).addClass("ajaxed"),s.active?a.addClass("active").siblings(".active").removeClass("active"):a.removeClass("active")})):(i.html(n),s.data&&s.data.msg&&notyf(s.data.msg,s.data.ys||"danger"))}})}),t.on("click",".bbs-posts-submit",function(){var a=$(this),t=a.attr("action"),e=a.parents("form"),i=e.serializeObject();i.action=t,tinyMCE&&(i.post_content=tinyMCE.activeEditor.getContent());var n=$(".featured-edit");if(n.length){var s=n.data("featured_data");i.featured_data=!!s&&s.data}zib_ajax(a,i,function(a){a.html&&e.find(".submit-text").html(a.html),a.post_id&&e.find('input[name="post_id"]').val(a.post_id)})}),$.fn.cloneable=function(){function a(a,t,n){var s=a.children().length;t&&t<=s?a.nextAll(e).hide():a.nextAll(e).show(),n&&n>=s?a.find(i).hide():a.find(i).show()}var t="cloneable",e="."+t+"-add",i="."+t+"-remove",n="."+t+"-item";return this.each(function(){var t=$(this),s=t.children(),d="is-on",o="click",l=t.data("max")||0,r=t.data("min")||0;if(a(t,l,r),s.length&&!t.attr(d)){var c=$(s[0]).clone(!1);c.find("input").val(""),t.attr(d,!0).on(o,i,function(){$($(this).parents(n)[0]).remove(),a(t,l,r)}).nextAll(e).on(o,function(){t.append(c.clone(!1)),a(t,l,r)})}})},$(".cloneable").cloneable(),t.on("change","[name='vote[type]']",function(){a($(this))}),a($("[name='vote[type]']")),$.fn.vote=function(){function a(a,t=0){var e=a.data(n+"-all")+t,i=a.data("type");a.find(p).each(function(){var a=$(this),t=a.data(n);a.children("."+u).length||a.prepend('<div class="'+u+'"></div>');var s=(t/e*100).toFixed(4);"px"!=i||e||(s="50%"),setTimeout(function(){a.children("."+u).css("width",s+"%")},200),a.children("."+m).html(~~s+"%"),a.children("."+v).html(t+"票")})}function t(t,i){i.action=f,t.hasClass(l)||(t.addClass(l),$.post(e,i,function(e){if(e.data){t.off(d).removeClass(l+" "+o).addClass(c),a(t,i.voted.length);var n=t.find("."+r);n.length&&n.text(1+~~n.text()),t.find("."+s).html("投票成功"),t.find(h).hide()}else t.removeClass(l)},"json"))}var e=_win.ajax_url,i="vote",n=i+"d",s=i+"-start",d="click",o=i+"-allow",l=i+"-loading",r=i+"-user-count",c=i+"-ok",u=i+"-progress",m=i+"-percentage",v=i+"-number",f="submit_"+i,p="."+i+"-item",h="."+i+"-submit",g="is-"+n,x="is-on";return this.each(function(){var e=$(this),i=e.data("type"),s=e.data("post-id"),r={id:s};if(a(e),e.hasClass(o)&&!e.data(x))if("multiple"===i){var c=e.find(h);e.data(x,!0).on(d,p,function(){var a=$(this),t=a.data(n);a.hasClass(g)?a.removeClass(g).data(n,t-1):a.addClass(g).data(n,t+1),e.find(p+"."+g).length?c.show():c.hide()}).on(d,h,function(){if(!e.hasClass(l)){var a=[];e.find(p).each(function(t){$(this).hasClass(g)&&a.push(t)}),r.voted=a,t(e,r)}})}else e.data(x,!0).on(d,p,function(){if(!e.hasClass(l)){var a=$(this).addClass(g),i=a.data(n);a.data(n,i+1);var s=a.data("index");r.voted=[s],t(e,r)}})})},document.addEventListener("lazybeforeunveil",function(a){var t=$(a.target);t.hasClass("vote-box")&&setTimeout(function(){t.vote()},500)}),t.on("miniuploaded","[term-taxonomy]",function(a,t){if(t.term_id){var e,i;if("add"===t.type)switch(t.taxonomy){case"plate_cat":if(e=$(".plate-cat-radio"),e.length)return e.find(".container-null").remove(),i=$('<label><input type="radio" name="cat" value="'+t.term_id+'"><span class="p2-10 mr6 but but-radio">'+t.term.name+"</span></label>"),e.prepend(i),i.click();break;case"forum_tag":if(e=$(".posts-tag-select"),e.length)return i=$('<span data-multiple="5" data-for="tag" data-value="'+t.term_id+'" class="tag-list ajax-item pointer"><span class="badg mm3">'+t.term.name+"</span></span>"),e.prepend(i),i.click();break;case"forum_topic":if(e=$(".posts-topic-select"),e.length)return i=$('<div data-for="topic" data-value="'+t.term_id+'" class="flex padding-10 topic-list ajax-item pointer"><div class="square-box mr10 thumb">'+(t.image_url?'<img src="'+t.image_url+'" class="fit-cover radius4">':"")+'</div><div class="info"><div class="name"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-topic"></use></svg>'+t.term.name+'<svg class="icon" aria-hidden="true"><use xlink:href="#icon-topic"></use></svg></div><div class="muted-3-color em09 desc"><span class="mr20">帖子:0</span><span class="">2秒前创建</span></div></div></div>'),e.prepend(i),i.click()}window.location.href=t.term_url,window.location.reload}}),t.on("miniuploaded","[plate-save]",function(a,t){if(t.id){if("add"===t.type){var e=$("#plate_select_tab_main");if(e.length){var i=$('<div data-for="plate" data-value="'+t.id+'" class="flex padding-10 plate-list ajax-item pointer"><div class="square-box mr10 thumb">'+(t.image_url?'<img src="'+t.image_url+'" class="radius-cover">':"")+'</div><div class="info"><div class="name">'+t.post.post_title+'</div><div class="muted-3-color em09 desc mt3">3秒前创建</div></div></div>');return e.prepend(i),$('[href="#plate_select_tab_main"]').click(),i.click()}}window.location.href=t.url,window.location.reload}}),t.on("zib_ajax.success",".answer-adopt-submit",function(a,t){t&&t.comment_id&&t.badeg&&$(".answer-adopt-id-"+t.comment_id).prop("outerHTML",t.badeg)})})();